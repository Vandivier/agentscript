<!DOCTYPE html>

<html>
<head>
  <title>mouse.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>mouse.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>A NetLogo-like mouse handler.
See: <a href="http://goo.gl/dq0nN">addEventListener</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>u = ABM.Util

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ABM</span>.<span class="hljs-title">Mouse</span></span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Create and start mouse obj, args: a model, and a callback method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  constructor: <span class="hljs-function"><span class="hljs-params">(@model, @callback)</span> -&gt;</span>
    @lastX = Infinity; @lastY = Infinity
    @div = @model.div
    @lastAgentsHovered = []
    @draggingAgents = []
    @divOffset = @model.div.getBoundingClientRect()
    @start()</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Start/stop the mouseListeners.  Note that NetLogoâ€™s model is to have
mouse move events always on, rather than starting/stopping them
on mouse down/up.  We may want do make that optional, using the
more standard down/up enabling move events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  start: <span class="hljs-function">-&gt;</span> <span class="hljs-comment"># Note: multiple calls safe</span>
    @div.addEventListener(<span class="hljs-string">"mousedown"</span>, @handleMouseDown, <span class="hljs-literal">false</span>)
    <span class="hljs-built_in">document</span>.body.addEventListener(<span class="hljs-string">"mouseup"</span>, @handleMouseUp, <span class="hljs-literal">false</span>)
    @div.addEventListener(<span class="hljs-string">"mousemove"</span>, @handleMouseMove, <span class="hljs-literal">false</span>)
    @model.<span class="hljs-literal">on</span>(<span class="hljs-string">'step'</span>, @handleStep)
    @lastX=@lastY=@x=@y=@pixX=@pixY=NaN; @moved=@down=<span class="hljs-literal">false</span>
  stop: <span class="hljs-function">-&gt;</span> <span class="hljs-comment"># Note: multiple calls safe</span>
    @div.removeEventListener(<span class="hljs-string">"mousedown"</span>, @handleMouseDown, <span class="hljs-literal">false</span>)
    <span class="hljs-built_in">document</span>.body.removeEventListener(<span class="hljs-string">"mouseup"</span>, @handleMouseUp, <span class="hljs-literal">false</span>)
    @div.removeEventListener(<span class="hljs-string">"mousemove"</span>, @handleMouseMove, <span class="hljs-literal">false</span>)
    @model.<span class="hljs-literal">off</span>(<span class="hljs-string">'step'</span>, @handleStep)
    @lastX=@lastY=@x=@y=@pixX=@pixY=NaN; @moved=@down=<span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Handlers for eventListeners</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  handleMouseDown: <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    @down = <span class="hljs-literal">true</span>
    @moved = <span class="hljs-literal">false</span>
    @handleMouseEvent(e)
  handleMouseUp: <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    @down = <span class="hljs-literal">false</span>
    @moved = <span class="hljs-literal">false</span>
    @handleMouseEvent(e)
  handleMouseMove: <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    @setXY(e)
    @moved = <span class="hljs-literal">true</span>
    @handleMouseEvent(e)
  handleStep: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    @delegateMouseOverAndOutEvents(@x, @y) <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isNaN(@x)
  handleMouseEvent: <span class="hljs-function"><span class="hljs-params">(e)</span> =&gt;</span>
    eventTypes = @computeEventTypes()
    @delegateEventsToAllAgents(eventTypes, e)
    @callback(e) <span class="hljs-keyword">if</span> @callback?

  getEventPos: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>modified from <a href="http://www.quirksmode.org/js/events_properties.html">http://www.quirksmode.org/js/events_properties.html</a>
previously used e.offsetX, e.offsetY, which was less robust
(failed in tiledroplets.html, for example)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    xPos = <span class="hljs-number">0</span>
    yPos = <span class="hljs-number">0</span>
    <span class="hljs-keyword">if</span> (e.pageX <span class="hljs-keyword">or</span> e.pageY)
      xPos = e.pageX
      yPos = e.pageY
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.clientX <span class="hljs-keyword">or</span> e.clientY)
      xPos = e.clientX + <span class="hljs-built_in">document</span>.body.scrollLeft + <span class="hljs-built_in">document</span>.documentElement.scrollLeft
      yPos = e.clientY + <span class="hljs-built_in">document</span>.body.scrollTop + <span class="hljs-built_in">document</span>.documentElement.scrollTop
    <span class="hljs-keyword">return</span> { x: xPos - @divOffset.left, y: yPos - @divOffset.top }

  setXY: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    eventPos = @getEventPos(e)
    @lastX = @x; @lastY = @y
    @pixX = eventPos.x; @pixY = eventPos.y
    [@x, @y] = @model.patches.pixelXYtoPatchXY(@pixX,@pixY)
    @dx = @lastX - @x; @dy = @lastY - @y

  computeEventTypes: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span>
    eventTypes = []

    <span class="hljs-keyword">if</span> @down <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> @moved
      eventTypes.push <span class="hljs-string">'mousedown'</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @down <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> @moved
      eventTypes.push <span class="hljs-string">'mouseup'</span>

    <span class="hljs-keyword">if</span> @down <span class="hljs-keyword">and</span> @moved
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @dragging
        eventTypes.push <span class="hljs-string">'dragstart'</span>
      @dragging = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @down <span class="hljs-keyword">and</span> @dragging
      @dragging = <span class="hljs-literal">false</span>
      @dragEnd = <span class="hljs-literal">true</span>

    <span class="hljs-keyword">if</span> @moved
      eventTypes.push <span class="hljs-string">'mousemove'</span>

    <span class="hljs-keyword">return</span> eventTypes

  delegateEventsToAllAgents: <span class="hljs-function"><span class="hljs-params">(types, e)</span> -&gt;</span>
    delegatedAgent = @delegateEventsToTurtlesAtPoint(types, @x, @y, e)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> delegatedAgent
      delegatedAgent = @delegateEventsToLinksAtPoint(types, @x, @y, e)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> delegatedAgent
      @delegateEventsToPatchAtPoint(types, @x, @y, e)
    @delegateDragEvents(@x, @y, e)
    @delegateMouseOverAndOutEvents(@x, @y, e)

  delegateEventsToPatchAtPoint: <span class="hljs-function"><span class="hljs-params">(eventTypes, x, y, e)</span> -&gt;</span>
    curPatch = @model.patches.patch(x, y)
    @emitAgentEvent(type, curPatch, @mouseEvent(curPatch, e)) <span class="hljs-keyword">for</span> type <span class="hljs-keyword">in</span> eventTypes

  delegateEventsToTurtlesAtPoint: <span class="hljs-function"><span class="hljs-params">(eventTypes, x, y, e)</span> -&gt;</span>
    curPatch = @model.patches.patch(x, y)</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>iterate through all turtles in this patch and its neighbors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> patch <span class="hljs-keyword">in</span> curPatch.n.concat(curPatch)
      <span class="hljs-keyword">for</span> turtle <span class="hljs-keyword">in</span> patch.turtlesHere()
        <span class="hljs-keyword">if</span> turtle.hitTest(x, y)
          @emitAgentEvent(type, turtle, @mouseEvent(turtle, e)) <span class="hljs-keyword">for</span> type <span class="hljs-keyword">in</span> eventTypes
          <span class="hljs-keyword">return</span> turtle

  delegateEventsToLinksAtPoint: <span class="hljs-function"><span class="hljs-params">(eventTypes, x, y, e)</span> -&gt;</span>
    <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> @model.links
      <span class="hljs-keyword">if</span> link.hitTest(x, y)
        mouseEvent = @mouseEvent(link, e)
        @emitAgentEvent(type, link, mouseEvent) <span class="hljs-keyword">for</span> type <span class="hljs-keyword">in</span> eventTypes
        <span class="hljs-keyword">return</span> link

  emitAgentEvent: <span class="hljs-function"><span class="hljs-params">(eventType, agent, mouseEvent)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> eventType == <span class="hljs-string">'dragstart'</span>
      @draggingAgents.push(agent)
    agent.breed.emit(eventType, mouseEvent)
    <span class="hljs-keyword">if</span> agent.breed.mainSet?
      agent.breed.mainSet.emit(eventType, mouseEvent)

  delegateDragEvents: <span class="hljs-function"><span class="hljs-params">(x, y, e)</span> =&gt;</span>
    <span class="hljs-keyword">for</span> agent <span class="hljs-keyword">in</span> @draggingAgents
      mouseEvent = @mouseEvent(agent, e)
      <span class="hljs-keyword">if</span> @moved <span class="hljs-keyword">then</span> @emitAgentEvent(<span class="hljs-string">'drag'</span>, agent, mouseEvent)
      <span class="hljs-keyword">if</span> @dragEnd <span class="hljs-keyword">then</span> @emitAgentEvent(<span class="hljs-string">'dragend'</span>, agent, mouseEvent)
    <span class="hljs-keyword">if</span> @dragEnd
      @draggingAgents = []
      @dragEnd = <span class="hljs-literal">false</span>

  delegateMouseOverAndOutEvents: <span class="hljs-function"><span class="hljs-params">(x, y, e)</span> =&gt;</span>
    agentsHere = {}
    agents = []
    curPatch = @model.patches.patch(x, y)

    agents = u.clone(@model.links)
    <span class="hljs-keyword">for</span> patch <span class="hljs-keyword">in</span> curPatch.n.concat(curPatch)
      agents = agents.concat(patch.turtlesHere())</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>mouseover</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> agent <span class="hljs-keyword">in</span> agents
      <span class="hljs-keyword">if</span> agent.hitTest(x, y)
        agentsHere[agent.breed.name] ?= {}
        agentsHere[agent.breed.name][agent.id] = agent
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> @lastAgentsHovered[agent.breed.name] <span class="hljs-keyword">or</span> agent.id <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> @lastAgentsHovered[agent.breed.name])
          @emitAgentEvent(<span class="hljs-string">'mouseover'</span>, agent, @mouseEvent(agent, e))</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>mouseout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> breedname <span class="hljs-keyword">of</span> @lastAgentsHovered
      <span class="hljs-keyword">for</span> agentId <span class="hljs-keyword">of</span> @lastAgentsHovered[breedname]
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> agentsHere[breedname] <span class="hljs-keyword">or</span> agentId <span class="hljs-keyword">not</span> <span class="hljs-keyword">of</span> agentsHere[breedname])
          agent = @lastAgentsHovered[breedname][agentId]
          @emitAgentEvent(<span class="hljs-string">'mouseout'</span>, agent, @mouseEvent(agent, e))

    @lastAgentsHovered = agentsHere

  mouseEvent: <span class="hljs-function"><span class="hljs-params">(agent, e)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> {target: agent, patchX: @x, patchY: @y, dx: @dx, dy: @dy, originalEvent: e}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
